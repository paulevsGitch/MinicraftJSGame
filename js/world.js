class Chunk{constructor(a,b){this.tiles=[],this.entities=new List,this.position=new Vec2(a,b),this.blockPosition=new Vec2(a<<4,b<<4),this.renderPosition=new Vec2(a<<8,b<<8),this.canvas=document.createElement("canvas"),this.canvas.width=256,this.canvas.height=256,this.needUpdate=!1}getIndex(a,b){return a<<4|b}getTile(a,b){return this.tiles[this.getIndex(a,b)]}setTile(a,b,c){this.tiles[this.getIndex(a,b)]=c}update(a){this.needUpdate=!1;let d=this.canvas.getContext("2d");d.clearRect(0,0,256,256);let j=[];for(let f=0;f<256;f++){let k=this.tiles[f];if(void 0!=k){let g=j[k.renderOrder];void 0==g&&(g=[],j[k.renderOrder]=g),g.push(f)}}j.forEach(b=>b.forEach(b=>{let f=this.tiles[b],c=b>>4,e=15&b;f.draw(a,d,c,e,this.blockPosition.x|c,this.blockPosition.y|e)}));for(let b=0;b<16;b++){let h=this.blockPosition.x|b,i=this.blockPosition.y|b,c=a.getTile(this.blockPosition.x-1,i);void 0!=c&&c.draw(a,d,-1,b,this.blockPosition.x-1,i),void 0!=(c=a.getTile(this.blockPosition.x+16,i))&&c.draw(a,d,16,b,this.blockPosition.x+16,i),void 0!=(c=a.getTile(h,this.blockPosition.y-1))&&c.draw(a,d,b,-1,h,this.blockPosition.y-1),void 0!=(c=a.getTile(h,this.blockPosition.y+16))&&c.draw(a,d,b,16,h,this.blockPosition.y+16)}for(let e=0;e<256;e++){let l=this.tiles[e];if(void 0!=l){let m=Tiles.overlayRender[l.id];if(void 0!=m){let n=e>>4,o=15&e;m(d,n,o)}}}}}const OverworldDayColors=[{r:255,g:255,b:255},{r:255,g:255,b:255},{r:255,g:255,b:255},{r:255,g:236,b:207},{r:255,g:145,b:117},{r:14,g:19,b:30},{r:14,g:19,b:30},{r:14,g:19,b:30},{r:255,g:145,b:117},{r:255,g:236,b:207}];class World{constructor(a){this.blockSize=a<<4,this.entityLimit=this.blockSize-.001,this.size=a,this.chunks=[],this.visibleEntities=new List,this.players=new List,this.dayCycle=300}getIndex(a,b){return a*this.size+b}getOrCreateChunk(b,c){let d=this.getIndex(b,c),a=this.chunks[d];return void 0===a&&(a=new Chunk(b,c),this.chunks[d]=a),a}getTile(c,d){let a=c>>4,b=d>>4;if(a<0||b<0||a>=this.size||b>=this.size)return;let f=this.getIndex(a,b),e=this.chunks[f];if(void 0!==e)return e.getTile(15&c,15&d)}setTile(c,d,f){let a=c>>4,b=d>>4;if(a<0||b<0||a>=this.size||b>=this.size)return;let e=this.getOrCreateChunk(a,b);e.setTile(15&c,15&d,f),e.needUpdate=!0}addEntity(a){let b=Math.floor(a.position.x)>>4,c=Math.floor(a.position.y)>>4;this.chunks[this.getIndex(b,c)].entities.add(a),a instanceof PlayerEntity&&this.players.add(a)}tick(a){this.chunks.forEach(c=>{if(void 0!=c){let e=c.entities.size;for(let d=0;d<e;d++){let b=c.entities.values[d];if(b.tick(this,a),b.alive){b.position.x=MathHelper.clamp(b.position.x,0,this.entityLimit),b.position.y=MathHelper.clamp(b.position.y,0,this.entityLimit);let f=Math.floor(b.position.x)>>4,g=Math.floor(b.position.y)>>4;(f!=c.position.x||g!=c.position.y)&&(this.chunks[this.getIndex(f,g)].entities.add(b),c.entities.remove(d),e--,d--)}else b.onDeath(this),c.entities.remove(d),e--,d--}}})}setAmbientLight(f,g){let d=g/this.dayCycle%this.dayCycle/this.dayCycle,e=Math.floor(d*OverworldDayColors.length),a=OverworldDayColors[e],b=OverworldDayColors[(e+1)%OverworldDayColors.length],c=d*OverworldDayColors.length%1,h=Math.floor(MathHelper.lerp(a.r,b.r,c)),i=Math.floor(MathHelper.lerp(a.g,b.g,c)),j=Math.floor(MathHelper.lerp(a.b,b.b,c));f.fillStyle="rgb("+h+","+i+","+j+")"}render(a){this.chunks.forEach(b=>{void 0!=b&&(b.needUpdate&&b.update(this),a.drawImage(b.canvas,b.renderPosition.x,b.renderPosition.y))}),this.visibleEntities.clear(),this.chunks.forEach(a=>{void 0!=a&&this.visibleEntities.add(a.entities)}),this.visibleEntities.sort((a,b)=>Math.sign(a.position.y-b.position.y)),this.visibleEntities.forEach(b=>{b.selected?(b.renderSelected(a),b.selected=!1):b.render(a)})}}