const GUI={};GUI.textures={},GUI.textures.button=Images.load("img/gui/button.png");class GUIElement{constructor(){this.position=new Vec2,this.size=new Vec2,this.size=new Vec2}render(a){}process(a,b){}}class Button extends GUIElement{constructor(a,b,c,d,e){super(),this.size=a,this.text=d,this.onClick=e,this.corner=b,this.fontSize=c,this.boundingBox=new BoundingBox(this.position,this.size)}render(a){a.fillStyle="white",Render.setFont(a,this.fontSize),Render.drawNineElements(a,GUI.textures.button,this.position.x,this.position.y,this.size.x,this.size.y,this.corner);let b=this.text;this.boundingBox.isInside(Controls.mouse.x,Controls.mouse.y)&&(b="> "+this.text+" <"),Render.printCentered(a,b,this.position.x+(this.size.x>>1),this.position.y+(this.size.y>>1))}process(a,b){void 0!=this.onClick&&this.boundingBox.isInside(a,b)&&this.onClick()}}GUI.makeDefaultButton=function(a,b){return new Button(new Vec2(512,128),32,64,a,b)};class Simple9Part extends GUIElement{constructor(a,b){super(),this.image=a,this.corner=b}render(a){Render.drawNineElements(a,this.image,this.position.x,this.position.y,this.size.x,this.size.y,this.corner)}}class ScaledImage extends GUIElement{constructor(a,b){super(),this.image=a,this.scale=b,this.size.set(a.width*b,a.height*b)}render(a){let b=this.image.width*this.scale,c=this.image.height*this.scale;a.drawImage(this.image,this.position.x,this.position.y,b,c)}}class Screen{constructor(a){this.elements=[],this.parent=a}addElement(a){this.elements.push(a)}render(a){Render.enableSmooth(a.context,!1),this.elements.forEach(b=>b.render(a.context)),Render.enableSmooth(a.context,!0)}onClick(a,b){this.elements.forEach(c=>c.process(a,b))}onResize(a,b,c){void 0!=this.parent&&this.parent.onResize(a,b,c)}onTick(){void 0!=this.parent&&Controls.isKeyPressed("Escape")&&this.returnToParent()}returnToParent(){Minicraft.screen=this.parent}}class MainMenuScreen extends Screen{constructor(){super(),this.logo=new ScaledImage(Images.load("img/gui/logo.png"),8),this.addElement(this.logo),this.border=new Simple9Part(Images.load("img/gui/borders.png"),64),this.addElement(this.border);let a=this;this.startButton=GUI.makeDefaultButton("START",function(){Minicraft.screen=new WorldScreen(a)}),this.addElement(this.startButton),this.optionsButton=GUI.makeDefaultButton("OPTIONS",function(){console.log("B")}),this.addElement(this.optionsButton),this.sourcesButton=GUI.makeDefaultButton("SOURCES",function(){window.location.href="https://github.com/paulevsGitch/MinicraftJS"}),this.addElement(this.sourcesButton)}onResize(a,b,c){super.onResize(a,b,c),this.logo.position.set(a.x-(this.logo.image.width<<2),(a.y>>1)-(this.logo.image.height<<3)),this.border.size.set(b,c),this.startButton.position.set(a.x-256,a.y-64-70),this.optionsButton.position.set(this.startButton.position.x,this.startButton.position.y+140),this.sourcesButton.position.set(this.startButton.position.x,this.optionsButton.position.y+140)}}class WorldScreen extends Screen{constructor(a){super(a),this.world=new World(4),WorldGenerator.generateWorld(this.world),Minicraft.inWorld=!0,this.player=new PlayerEntity,this.player.position.set(31,31),this.world.addEntity(this.player),Minicraft.renderContext.camera.target=this.player,this.light=Images.load("img/light/light_64.png")}render(c){let e=c.canvas.height,f=c.canvas.width,a=c.camera,b=c.context,d=c.lightmap;this.world.tick(c.delta),void 0!=a.target&&a.position.set(a.target.position).multiply(16).subtract(0,8),Render.enableSmooth(b,!1),b.transform(a.zoom,0,0,a.zoom,.5*f,.5*e),b.transform(1,0,0,1,-a.position.x,-a.position.y);let j=b.getTransform();this.world.render(b);let h=Controls.mouse,k=((h.x-.5*f)/a.zoom+a.position.x)/16,l=((h.y-.5*e)/a.zoom+a.position.y)/16,i=c.screenArea;i.position.set(-(.5*f),-(.5*e)).divide(a.zoom).add(a.position).divide(16),i.size.set(f,e).divide(16*a.zoom);let g=this.player.inventory;g.selected> -1&&g.items[g.selected].item.renderOnCursor(b,k,l),Entities.mutableBox.size.set(8),this.world.visibleEntities.forEach(a=>{Entities.mutableBox.position.set(a.position).subtract(4),a.visible=i.collides(Entities.mutableBox)}),Entities.mutableBox.size.set(1),this.selected=void 0,this.world.visibleEntities.forEach(a=>{if(void 0!=a.selectionBox&&a.selectionBox.isInside(k,l))return a.selected=!0,this.selected=a,!0}),b.setTransform(),this.world.setAmbientLight(d.context,c.time),Render.enableSmooth(d.context,!1),d.context.setTransform(),Render.defaultBlending(d.context),d.context.fillRect(0,0,f,e),d.context.setTransform(j),Render.screenBlending(d.context),d.context.drawImage(this.light,a.position.x-(this.light.width>>1),a.position.y-(this.light.height>>1)),Render.multiplyBlending(b),c.context.drawImage(d.canvas,0,0),Render.defaultBlending(b),Render.enableSmooth(b,!0)}onTick(){super.onTick(),Controls.isKeyPressed("KeyR")&&WorldGenerator.generateWorld(this.world),Controls.isKeyPressed("KeyE")&&(Minicraft.screen=new InventoryScreen(this,this.player));let a=Minicraft.renderContext.camera;void 0===a.target&&(a.movement.set(0,0),Controls.isKeyHold("KeyW")&&(a.movement.y-=1),Controls.isKeyHold("KeyS")&&(a.movement.y+=1),Controls.isKeyHold("KeyA")&&(a.movement.x-=1),Controls.isKeyHold("KeyD")&&(a.movement.x+=1),a.position.add(a.movement.normalize().multiply(100*Minicraft.renderContext.delta)))}onClick(e,f){super.onClick(e,f),void 0!=this.selected&&(this.selected.alive=!1);let a=this.player.inventory;if(a.selected> -1){let c=a.items[a.selected],d=Minicraft.renderContext,g=d.canvas.height,h=d.canvas.width,b=d.camera,i=((e-.5*h)/b.zoom+b.position.x)/16,j=((f-.5*g)/b.zoom+b.position.y)/16;c.item.onUse(this.world,i,j,c),c.count<1&&(a.items.splice(a.selected,1),a.selected=-1)}}returnToParent(){super.returnToParent(),Minicraft.inWorld=!1}}class InventoryScreen extends Screen{constructor(a,b){super(a),this.player=b,this.cache=[]}render(b){this.parent.render(b);let c=b.canvas.height,d=b.canvas.width,a=b.context;a.setTransform(),Render.enableSmooth(a,!1),Render.setAlpha(a,.5),a.fillStyle="black",a.fillRect(0,0,d,c),Render.setAlpha(a,1);let e=d-512>>1,f=c-512>>1;Render.drawNineElements(a,GUI.textures.button,e,f,512,512,32),Render.setFont(a),a.fillStyle="white";let g=this.player.inventory,h=0;g.items.forEach(b=>{let c=(7&h)*64+e+32,d=(h>>3)*64+f+32;b.item.id===g.selected&&(a.strokeStyle="white",a.lineWidth=4,a.beginPath(),a.rect(c,d,64,64),a.stroke(),a.lineWidth=1),a.drawImage(b.item.image,c,d,64,64),b.count>1&&Render.printRightBottom(a,b.count,c+60,d+60),this.cache[h]=b.item.id,h++}),Render.enableSmooth(a,!0)}onClick(d,e){super.onClick(d,e);let g=Minicraft.renderContext.canvas.height,h=Minicraft.renderContext.canvas.width,b=d-((h-512>>1)+32)>>6,c=e-((g-512>>1)+32)>>6,a=this.player.inventory;if(b<0||c<0||b>7||c>7){a.selected=-1;return}let f=c<<3|b;if(f>=a.items.length){a.selected=-1;return}a.selected=this.cache[f]}}